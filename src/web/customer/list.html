<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>顧客情報一覧</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../assets/css/style.css" />
  </head>
  <body>
    <div class="app-shell">
      <header class="app-header">
        <div class="container d-flex justify-content-between align-items-center">
          <div>
            <h1 class="app-title mb-0">
              <a href="../index.html" class="text-white text-decoration-none">顧客管理システム</a>
            </h1>
          </div>
          <nav>
            <ul class="nav">
              <li class="nav-item"><a class="nav-link text-white active" href="./list.html">顧客</a></li>
              <li class="nav-item"><a class="nav-link text-white" href="../case/list.html">案件</a></li>
              <li class="nav-item"><a class="nav-link text-white" href="../negotiation/list.html">交渉</a></li>
            </ul>
          </nav>
        </div>
      </header>

      <section class="app-actions">
        <form id="search-form" class="d-flex flex-grow-1 mr-3">
          <input type="search" id="search-input" class="form-control" placeholder="会社名で検索...">
        </form>
        <div class="app-cta-group">
          <a href="add.html" class="btn btn-primary">新規登録</a>
        </div>
      </section>

      <div id="industry-tags" class="mb-4 d-flex flex-wrap gap-2"></div>

      <section class="app-card app-table">
        <table class="table mb-0">
          <thead>
            <tr>
              <th scope="col">
                <input type="checkbox" id="select-all" aria-label="顧客を全選択" />
              </th>
              <th scope="col">会社名</th>
              <th scope="col">連絡先</th>
              <th scope="col">業種</th>
            </tr>
          </thead>
          <tbody id="customer-list">
            <tr>
              <td colspan="4" class="text-center text-muted py-4">読み込み中です...</td>
            </tr>
          </tbody>
        </table>
      </section>
      <div id="pagination" class="pagination-controls d-flex justify-content-center mt-4 d-none"></div>
    </div>

    <script type="module">
      import config from "../config.js";

      const list = document.getElementById("customer-list");
      const searchInput = document.getElementById("search-input");
      const tagsContainer = document.getElementById("industry-tags");
      const paginationContainer = document.getElementById("pagination");
      const selectAllCheckbox = document.getElementById("select-all");
      const bulkDeleteButton = document.createElement("button");
      selectAllCheckbox.checked = false;
      selectAllCheckbox.disabled = true;
      
      let allCustomers = [];
      let currentSearchTerm = "";
      let selectedIndustry = "";
      let currentPage = 1;
      const ITEMS_PER_PAGE = 15;
      const selectedCustomerIds = new Set();

      bulkDeleteButton.type = "button";
      bulkDeleteButton.id = "bulk-delete-button";
      bulkDeleteButton.className = "btn btn-danger ml-3";
      bulkDeleteButton.textContent = "選択削除";
      bulkDeleteButton.disabled = true;

      document.querySelector(".app-cta-group").appendChild(bulkDeleteButton);

      const updateBulkDeleteButton = () => {
        bulkDeleteButton.disabled = selectedCustomerIds.size === 0;
      };

      const syncSelectAllState = () => {
        const checkboxes = list.querySelectorAll('input.customer-select');
        const totalVisible = checkboxes.length;

        if (!totalVisible) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
          selectAllCheckbox.disabled = true;
          return;
        }

        selectAllCheckbox.disabled = false;
        const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        selectAllCheckbox.checked = checkedCount === totalVisible;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < totalVisible;
      };

      const handleSelectionChange = (customerId, isSelected) => {
        const id = Number(customerId);
        if (!Number.isInteger(id)) {
          return;
        }
        if (isSelected) {
          selectedCustomerIds.add(id);
        } else {
          selectedCustomerIds.delete(id);
        }
        updateBulkDeleteButton();
        syncSelectAllState();
      };

      const readJsonOrThrow = async (response, defaultErrorMessage) => {
        const message = defaultErrorMessage || "削除に失敗しました。";
        const contentType = response.headers.get("content-type") || "";

        if (!contentType.includes("application/json")) {
          if (!response.ok) {
            throw new Error(`${message} (status: ${response.status})`);
          }
          throw new Error("予期しないレスポンス形式が返されました。");
        }

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.message || `${message} (status: ${response.status})`);
        }

        return data;
      };

      // フィルタリングとテーブル描画をまとめて行う関数
      const applyFiltersAndRender = () => {
        let filteredCustomers = allCustomers;

        // 業種で絞り込み
        if (selectedIndustry) {
          filteredCustomers = filteredCustomers.filter(c => c.industry === selectedIndustry);
        }

        // 検索語で絞り込み
        if (currentSearchTerm) {
          filteredCustomers = filteredCustomers.filter(c => 
            c.company_name.toLowerCase().includes(currentSearchTerm)
          );
        }

        const totalPages = Math.ceil(filteredCustomers.length / ITEMS_PER_PAGE);
        if (!filteredCustomers.length) {
          currentPage = 1;
        } else if (currentPage > totalPages) {
          currentPage = totalPages;
        }

        renderTable(filteredCustomers);
        renderPagination(totalPages);
      };

      // テーブルをレンダリングする関数
      const renderTable = (customers) => {
        list.innerHTML = "";

        if (!customers.length) {
          const emptyRow = list.insertRow();
          const cell = emptyRow.insertCell(0);
          cell.colSpan = 4;
          cell.classList.add("text-center", "py-5");
          cell.innerHTML = '<div class="empty-message">該当する顧客が見つかりません。</div>';
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
          selectAllCheckbox.disabled = true;
          return;
        }

        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const pageCustomers = customers.slice(startIndex, startIndex + ITEMS_PER_PAGE);

        pageCustomers.forEach(customer => {
          const row = list.insertRow();

          const selectCell = row.insertCell(0);
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "customer-select";
          checkbox.dataset.customerId = customer.customer_id;
          checkbox.checked = selectedCustomerIds.has(customer.customer_id);
          checkbox.addEventListener("change", (event) => {
            handleSelectionChange(customer.customer_id, event.target.checked);
          });
          selectCell.appendChild(checkbox);
          
          const nameCell = row.insertCell(1);
          const link = document.createElement("a");
          link.href = `detail.html?id=${customer.customer_id}`;
          link.textContent = customer.company_name;
          link.classList.add("font-weight-bold");
          nameCell.appendChild(link);

          row.insertCell(2).textContent = customer.contact || "-";
          
          const industryCell = row.insertCell(3);
          const industryBadge = document.createElement('span');
          industryBadge.className = 'badge-industry';
          industryBadge.textContent = customer.industry;
          industryCell.appendChild(industryBadge);
        });

        syncSelectAllState();
      };

      const renderPagination = (totalPages) => {
        paginationContainer.innerHTML = "";

        if (totalPages <= 1) {
          paginationContainer.classList.add("d-none");
          return;
        }

        paginationContainer.classList.remove("d-none");

        const createNavButton = (label, targetPage, disabled) => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "pagination-btn";
          button.textContent = label;

          if (disabled) {
            button.disabled = true;
          } else {
            button.addEventListener("click", () => {
              currentPage = targetPage;
              applyFiltersAndRender();
            });
          }

          paginationContainer.appendChild(button);
        };

        createNavButton("前へ", currentPage - 1, currentPage === 1);

        for (let page = 1; page <= totalPages; page += 1) {
          const pageButton = document.createElement("button");
          pageButton.type = "button";
          pageButton.className = "pagination-btn";
          pageButton.textContent = page;
          if (page === currentPage) {
            pageButton.classList.add("active");
          } else {
            pageButton.addEventListener("click", () => {
              currentPage = page;
              applyFiltersAndRender();
            });
          }
          paginationContainer.appendChild(pageButton);
        }

        createNavButton("次へ", currentPage + 1, currentPage === totalPages);
      };

      // 業種タグをレンダリングする関数
      const renderTags = () => {
        const industries = ['All', ...new Set(allCustomers.map(c => c.industry))];
        tagsContainer.innerHTML = "";
        
        industries.forEach(industry => {
          const tag = document.createElement('span');
          tag.className = 'badge-industry';
          tag.textContent = industry;
          if (industry === (selectedIndustry || 'All')) {
            tag.classList.add('active');
          }

          tag.addEventListener('click', () => {
            selectedIndustry = (industry === 'All') ? "" : industry;
            currentPage = 1;
            document.querySelectorAll('#industry-tags .badge-industry').forEach(t => t.classList.remove('active'));
            tag.classList.add('active');
            applyFiltersAndRender();
          });
          tagsContainer.appendChild(tag);
        });
      };

      // 検索イベントのリスナー
      searchInput.addEventListener("input", () => {
        currentSearchTerm = searchInput.value.toLowerCase();
        currentPage = 1;
        applyFiltersAndRender();
      });

      selectAllCheckbox.addEventListener("change", (event) => {
        const isChecked = event.target.checked;
        const checkboxes = list.querySelectorAll('input.customer-select');
        checkboxes.forEach((checkbox) => {
          checkbox.checked = isChecked;
          const customerId = Number(checkbox.dataset.customerId);
          if (isChecked) {
            selectedCustomerIds.add(customerId);
          } else {
            selectedCustomerIds.delete(customerId);
          }
        });
        updateBulkDeleteButton();
        syncSelectAllState();
      });

      bulkDeleteButton.addEventListener("click", async () => {
        if (selectedCustomerIds.size === 0) {
          return;
        }

        const ids = Array.from(selectedCustomerIds);
        if (!confirm(`選択した ${ids.length} 件の顧客を削除しますか？`)) {
          return;
        }

        const removeCustomersFromState = (removedIds) => {
          if (!removedIds.length) {
            return;
          }
          const removedSet = new Set(removedIds);
          allCustomers = allCustomers.filter(customer => !removedSet.has(Number(customer.customer_id)));
          removedIds.forEach(id => selectedCustomerIds.delete(id));
          updateBulkDeleteButton();
          applyFiltersAndRender();
        };

        try {
          const response = await fetch(`${config.apiUrl}/customers/bulk-delete`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ids }),
          });

          const result = await readJsonOrThrow(response, "削除に失敗しました。");
          if (!result.success) {
            throw new Error(result.message || "削除に失敗しました。");
          }

          removeCustomersFromState(ids);
          alert(`顧客情報を${result.deletedCount || ids.length}件削除しました。`);
        } catch (error) {
          console.warn("Bulk delete endpoint failed, attempting individual deletions.", error);

          const successfulIds = [];
          const failedIds = [];

          for (const id of ids) {
            try {
              const response = await fetch(`${config.apiUrl}/customers/${id}`, {
                method: "DELETE",
              });
              const data = await readJsonOrThrow(response, "削除に失敗しました。");
              if (data.success) {
                successfulIds.push(id);
              } else {
                failedIds.push(id);
              }
            } catch (individualError) {
              failedIds.push(id);
            }
          }

          removeCustomersFromState(successfulIds);

          if (successfulIds.length) {
            alert(`顧客情報を${successfulIds.length}件削除しました。`);
          }

          if (failedIds.length) {
            const failedCount = failedIds.length;
            const detail = failedCount === ids.length
              ? "削除に失敗しました。"
              : `一部の顧客の削除に失敗しました。（${failedCount}件）`;
            alert(detail);
          }
        }
      });

      // 初期データの取得
      fetch(`${config.apiUrl}/customers`)
        .then((response) => response.json())
        .then((data) => {
          allCustomers = data;
          if (!allCustomers.length) {
            list.innerHTML = "";
            const emptyRow = list.insertRow();
            const cell = emptyRow.insertCell(0);
            cell.colSpan = 4;
            cell.classList.add("text-center", "py-5");
            cell.innerHTML = '<div class="empty-message">まだ登録された顧客がありません。<br>「新規登録」から追加してみましょう。</div>';
            paginationContainer.innerHTML = "";
            paginationContainer.classList.add("d-none");
            selectAllCheckbox.disabled = true;
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            return;
          }
          renderTags();
          currentPage = 1;
          applyFiltersAndRender();
        })
        .catch(() => {
          list.innerHTML = "";
          const errorRow = list.insertRow();
          const cell = errorRow.insertCell(0);
          cell.colSpan = 4;
          cell.classList.add("text-center", "py-5");
          cell.innerHTML = '<div class="empty-message">データの取得に失敗しました。時間をおいて再度お試しください。</div>';
          paginationContainer.innerHTML = "";
          paginationContainer.classList.add("d-none");
          selectAllCheckbox.disabled = true;
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  </body>
</html>
