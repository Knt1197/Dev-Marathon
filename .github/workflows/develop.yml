name: ssh command

on:
  push:
    branches:
      - develop

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      # 🔹 ソースコードを取得
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ← 完全な履歴を取得（タグ・コミット情報も利用可）

      # 🔹 SSHでリモートサーバーにデプロイ
      - id: ssh
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          port: ${{ secrets.DEV_SSH_PORT }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.DEV_SSH_SSH_KEY }}
          script: |
            set -e
            echo "🚀 ステージングサーバーへデプロイを開始します..."
            cd /app/kanta_maruhashi
            for file in deploy.sh deploy_staging.sh deploy_production.sh; do
              if [ -f "$file" ] && ! git ls-files --error-unmatch "$file" >/dev/null 2>&1; then
                rm -f "$file"
              fi
            done

            # ✅ Gitリポジトリを最新化（ローカル変更を破棄して最新状態へ）
            echo "📦 最新ソースを取得中..."
            git fetch origin develop
            git reset --hard origin/develop

            # ✅ Node.jsの依存関係をインストール/更新
            echo "📥 依存関係をインストール中..."
            cd src/node && npm install && cd ../..

            # ✅ 'staging' を引数として deploy.sh を実行し、環境変数をセット
            echo "🔧 環境変数を設定中..."
            bash deploy_staging.sh

            echo "✅ デプロイ完了！"
