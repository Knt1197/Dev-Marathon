name: 'ステージングテスト＋本番デプロイ'

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 🔹 ステージング環境でテストを実行
      - name: "ステージングでのテスト実行"
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          port: ${{ secrets.DEV_SSH_PORT }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.DEV_SSH_SSH_KEY }}
          script: |
            set -e
            cd /ci/
            echo "🧪 ステージング環境で Cypress テストを実行中..."
            npx cypress run --browser chrome --spec cypress/e2e/kanta_maruhashi.cy.js
            echo "✅ ステージングテスト完了！"

      # 🔹 テスト成功時のみ本番デプロイを実行
      - name: "本番サーバーへデプロイ"
        if: success()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.MAIN_SSH_HOST }}
          port: ${{ secrets.MAIN_SSH_PORT }}
          username: ${{ secrets.MAIN_SSH_USER }}
          key: ${{ secrets.MAIN_SSH_SSH_KEY }}
          script: |
            set -e
            echo "🚀 本番サーバーへのデプロイを開始します..."
            cd /app/kanta_maruhashi
            for file in deploy.sh deploy_staging.sh deploy_production.sh; do
              if [ -f "$file" ] && ! git ls-files --error-unmatch "$file" >/dev/null 2>&1; then
                rm -f "$file"
              fi
            done
            git pull origin main
            bash deploy_production.sh
            echo "✅ デプロイ完了！"
