name: 'ステージングテスト＋本番デプロイ'

on:
  push:
    branches:
      - main  # mainブランチへのpushで実行

jobs:
  # ===========================
  # 🔹 ステージング環境での自動テスト
  # ===========================
  test:
    name: ステージングテスト
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Cypressテスト実行（ステージング）"
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          port: ${{ secrets.DEV_SSH_PORT }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.DEV_SSH_SSH_KEY }}
          script: |
            set -e  # ← これでCypress失敗時は即停止
            echo "ステージングテスト実行中"
            cd /ci/
            npx cypress run --browser chrome --spec cypress/e2e/kanta_maruhashi.cy.js
            echo "ステージングテスト ｸﾘｱｰｯ"

  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: test        # ← testジョブが成功しないと実行されない
    if: success()      # ← さらに保険で明示
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "本番サーバーへデプロイ"
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.MAIN_SSH_HOST }}
          port: ${{ secrets.MAIN_SSH_PORT }}
          username: ${{ secrets.MAIN_SSH_USER }}
          key: ${{ secrets.MAIN_SSH_SSH_KEY }}
          script: |
            set -e  # ← デプロイ途中で失敗しても即停止
            echo "デプロイ ｽﾀｰﾄ"
            cd /app/kanta_maruhashi

            # ✅ Gitリポジトリを最新化
            echo "📦 最新ソースを取得中..."
            git pull origin main

            # ✅ コピー元が存在するかチェック
            if [ ! -d "./src/web" ]; then
              echo "❌ src/web が存在しません。デプロイを中止します。"
              exit 1
            fi

            echo "📂 src/web の内容を確認:"
            ls -l ./src/web | head -n 10

            # デプロイスクリプト実行
            bash /app/kanta_maruhashi/deploy.sh kanta_maruhashi

            echo "✅ デプロイ完了！"
