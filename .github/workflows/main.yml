name: 'ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ†ã‚¹ãƒˆï¼‹æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤'

on:
  push:
    branches:
      - main  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§å®Ÿè¡Œ

jobs:
  # ===========================
  # ğŸ”¹ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®è‡ªå‹•ãƒ†ã‚¹ãƒˆ
  # ===========================
  test:
    name: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Cypressãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ï¼‰"
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          port: ${{ secrets.DEV_SSH_PORT }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.DEV_SSH_SSH_KEY }}
          script: |
            set -e  # â† ã“ã‚Œã§Cypresså¤±æ•—æ™‚ã¯å³åœæ­¢
            echo "ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­"
            cd /ci/
            npx cypress run --browser chrome --spec cypress/e2e/kanta_maruhashi.cy.js
            echo "ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ ï½¸ï¾˜ï½±ï½°ï½¯"

  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: test        # â† testã‚¸ãƒ§ãƒ–ãŒæˆåŠŸã—ãªã„ã¨å®Ÿè¡Œã•ã‚Œãªã„
    if: success()      # â† ã•ã‚‰ã«ä¿é™ºã§æ˜ç¤º
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã¸ãƒ‡ãƒ—ãƒ­ã‚¤"
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.MAIN_SSH_HOST }}
          port: ${{ secrets.MAIN_SSH_PORT }}
          username: ${{ secrets.MAIN_SSH_USER }}
          key: ${{ secrets.MAIN_SSH_SSH_KEY }}
          script: |
            set -e  # â† ãƒ‡ãƒ—ãƒ­ã‚¤é€”ä¸­ã§å¤±æ•—ã—ã¦ã‚‚å³åœæ­¢
            echo "ãƒ‡ãƒ—ãƒ­ã‚¤ ï½½ï¾€ï½°ï¾„"
            cd /app/kanta_maruhashi

            # âœ… Gitãƒªãƒã‚¸ãƒˆãƒªã‚’æœ€æ–°åŒ–
            echo "ğŸ“¦ æœ€æ–°ã‚½ãƒ¼ã‚¹ã‚’å–å¾—ä¸­..."
            git pull origin main

            # âœ… ã‚³ãƒ”ãƒ¼å…ƒãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if [ ! -d "./src/web" ]; then
              echo "âŒ src/web ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚"
              exit 1
            fi

            echo "ğŸ“‚ src/web ã®å†…å®¹ã‚’ç¢ºèª:"
            ls -l ./src/web | head -n 10

            # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
            bash /app/kanta_maruhashi/deploy.sh kanta_maruhashi

            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼"
