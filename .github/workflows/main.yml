name: 'ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ†ã‚¹ãƒˆï¼‹æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤'

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ğŸ”¹ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      - name: "ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          port: ${{ secrets.DEV_SSH_PORT }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.DEV_SSH_SSH_KEY }}
          script: |
            set -e
            cd /ci/
            echo "ğŸ§ª ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ Cypress ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
            npx cypress run --browser chrome --spec cypress/e2e/kanta_maruhashi.cy.js
            echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Œäº†ï¼"

      # ğŸ”¹ ãƒ†ã‚¹ãƒˆæˆåŠŸæ™‚ã®ã¿æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ
      - name: "æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã¸ãƒ‡ãƒ—ãƒ­ã‚¤"
        if: success()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.MAIN_SSH_HOST }}
          port: ${{ secrets.MAIN_SSH_PORT }}
          username: ${{ secrets.MAIN_SSH_USER }}
          key: ${{ secrets.MAIN_SSH_SSH_KEY }}
          script: |
            set -e
            echo "ğŸš€ æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™..."
            cd /app/kanta_maruhashi
            for file in deploy.sh deploy_staging.sh deploy_production.sh; do
              if [ -f "$file" ] && ! git ls-files --error-unmatch "$file" >/dev/null 2>&1; then
                rm -f "$file"
              fi
            done
            git pull origin main
            bash deploy_production.sh
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼"
